#cloud-config
ssh_authorized_keys:
  - ${key_pairs}
coreos:
  units:
    - name: rsyslog-proxy.service
      command: start
      runtime: true
      content: |
        [Unit]
        Description=Rsyslog Proxy Server
        Requires=docker.socket
        After=docker.socket

        [Service]
        Environment=SERVICE=rsyslog-proxy
        Environment=DOCKER_NAME=kam1kaze/rsyslog-proxy
        Environment=VERSION=latest
        Restart=on-failure
        RestartSec=30
        ExecStartPre=-/usr/bin/docker kill $${SERVICE}
        ExecStartPre=-/usr/bin/docker rm $${SERVICE}
        ExecStartPre=/usr/bin/docker pull $${DOCKER_NAME}:$${VERSION}
        ExecStartPre=/usr/bin/install -d -g 0 -o 0 -m 700 /data/logs
        ExecStart=/usr/bin/docker run --name $${SERVICE} \
                                      -e REMOTE_ADDR=${rsyslog_remote_address} \
                                      $${DOCKER_NAME}:$${VERSION}
    - name: nginx.service
      command: start
      runtime: true
      content: |
        [Unit]
        Description=Nginx Test Daemon
        Requires=docker.socket rsyslog-proxy.service
        After=docker.socket rsyslog-proxy.service

        [Service]
        Environment=SERVICE=nginx
        Environment=DOCKER_NAME=nginx
        Environment=VERSION=alpine
        Restart=on-failure
        RestartSec=30
        ExecStartPre=-/usr/bin/docker kill $${SERVICE}
        ExecStartPre=-/usr/bin/docker rm $${SERVICE}
        ExecStartPre=/usr/bin/docker pull $${DOCKER_NAME}:$${VERSION}
        ExecStart=/usr/bin/docker run --name $${SERVICE} \
                                      --volumes-from rsyslog-proxy \
                                      -p 80:80 \
                                      $${DOCKER_NAME}:$${VERSION} \
                                      sh -xc 'mkdir -p /var/log/nginx/ && exec nginx -g "daemon off;"'
